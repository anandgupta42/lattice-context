<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lattice Context Layer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Lattice Context Layer</h1>
                    <p class="text-gray-600">Institutional knowledge for AI assistants</p>
                </div>
                <div class="flex space-x-4">
                    <button onclick="showDashboard()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" id="dashboardBtn">Dashboard</button>
                    <button onclick="showSearch()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" id="searchBtn">Search</button>
                    <button onclick="showGraph()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" id="graphBtn">Graph</button>
                    <button onclick="showEntities()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" id="entitiesBtn">Entities</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <!-- Dashboard View -->
        <div id="dashboardView">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <!-- Stats Cards -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="text-sm text-gray-600">Total Decisions</div>
                    <div class="text-3xl font-bold text-blue-600" id="statDecisions">-</div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="text-sm text-gray-600">Entities</div>
                    <div class="text-3xl font-bold text-green-600" id="statEntities">-</div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="text-sm text-gray-600">Conventions</div>
                    <div class="text-3xl font-bold text-purple-600" id="statConventions">-</div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="text-sm text-gray-600">Corrections</div>
                    <div class="text-3xl font-bold text-orange-600" id="statCorrections">-</div>
                </div>
            </div>

            <!-- Recent Decisions -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">Recent Decisions</h2>
                </div>
                <div class="p-6">
                    <div id="recentDecisions" class="space-y-4">
                        <div class="text-gray-500 text-center py-8">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search View -->
        <div id="searchView" class="hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex space-x-4">
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Search decisions..."
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onkeypress="if(event.key==='Enter') searchDecisions()"
                    >
                    <button onclick="searchDecisions()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        Search
                    </button>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow">
                <div id="searchResults" class="p-6">
                    <div class="text-gray-500 text-center py-8">Enter a search query to find decisions</div>
                </div>
            </div>
        </div>

        <!-- Graph View -->
        <div id="graphView" class="hidden">
            <div class="bg-white rounded-lg shadow mb-4">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900">Decision Graph</h2>
                    <div class="flex space-x-4">
                        <select id="entityTypeFilter" onchange="loadGraph()" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">All Types</option>
                            <option value="model">Models</option>
                            <option value="column">Columns</option>
                            <option value="table">Tables</option>
                            <option value="view">Views</option>
                        </select>
                        <button onclick="exportGraph()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                            Export PNG
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="graphContainer" class="bg-gray-50 rounded-lg" style="height: 600px; position: relative;">
                        <svg id="graphSvg" width="100%" height="100%"></svg>
                        <div id="nodeTooltip" class="hidden absolute bg-white border border-gray-300 rounded-lg shadow-lg p-4 max-w-md" style="pointer-events: none; z-index: 1000;">
                            <div id="tooltipContent"></div>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-gray-600">
                        <p><strong>Tip:</strong> Click and drag nodes to rearrange. Hover over nodes to see details.</p>
                        <p class="mt-2"><span class="inline-block w-3 h-3 bg-blue-500 rounded-full mr-1"></span> Evolution (same entity over time)</p>
                        <p><span class="inline-block w-3 h-3 bg-green-500 rounded-full mr-1"></span> Related (similar entities)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Entities View -->
        <div id="entitiesView" class="hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">All Entities</h2>
                </div>
                <div class="p-6">
                    <div id="entitiesList" class="space-y-4">
                        <div class="text-gray-500 text-center py-8">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // State management
        let currentView = 'dashboard';

        // Navigation
        function showDashboard() {
            currentView = 'dashboard';
            updateNav();
            loadDashboard();
        }

        function showSearch() {
            currentView = 'search';
            updateNav();
        }

        function showGraph() {
            currentView = 'graph';
            updateNav();
            loadGraph();
        }

        function showEntities() {
            currentView = 'entities';
            updateNav();
            loadEntities();
        }

        function updateNav() {
            document.getElementById('dashboardView').style.display = currentView === 'dashboard' ? 'block' : 'none';
            document.getElementById('searchView').style.display = currentView === 'search' ? 'block' : 'none';
            document.getElementById('graphView').style.display = currentView === 'graph' ? 'block' : 'none';
            document.getElementById('entitiesView').style.display = currentView === 'entities' ? 'block' : 'none';

            // Update button styles
            const buttons = ['dashboardBtn', 'searchBtn', 'graphBtn', 'entitiesBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btnId === currentView + 'Btn') {
                    btn.className = 'px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600';
                } else {
                    btn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300';
                }
            });
        }

        // API calls
        async function loadDashboard() {
            try {
                // Load stats
                const stats = await fetch('/api/stats').then(r => r.json());
                document.getElementById('statDecisions').textContent = stats.total_decisions;
                document.getElementById('statEntities').textContent = stats.total_entities;
                document.getElementById('statConventions').textContent = stats.total_conventions;
                document.getElementById('statCorrections').textContent = stats.total_corrections;

                // Load recent decisions
                const decisions = await fetch('/api/decisions?limit=10').then(r => r.json());
                renderDecisions(decisions, 'recentDecisions');
            } catch (err) {
                console.error('Error loading dashboard:', err);
            }
        }

        async function searchDecisions() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query, limit: 20})
                });
                const decisions = await response.json();
                renderDecisions(decisions, 'searchResults');
            } catch (err) {
                console.error('Error searching:', err);
                document.getElementById('searchResults').innerHTML =
                    '<div class="text-red-500 text-center py-8">Error searching decisions</div>';
            }
        }

        // Graph visualization
        let graphData = null;
        let simulation = null;

        async function loadGraph() {
            const entityType = document.getElementById('entityTypeFilter').value;
            const url = entityType ? `/api/graph?entity_type=${entityType}&limit=50` : '/api/graph?limit=50';

            try {
                graphData = await fetch(url).then(r => r.json());
                renderGraph(graphData);
            } catch (err) {
                console.error('Error loading graph:', err);
            }
        }

        function renderGraph(data) {
            const container = document.getElementById('graphContainer');
            const svg = d3.select('#graphSvg');
            svg.selectAll('*').remove(); // Clear previous graph

            const width = container.clientWidth;
            const height = container.clientHeight;

            // Color scale for node types
            const colorScale = d3.scaleOrdinal()
                .domain(['model', 'column', 'table', 'view', 'metric', 'dimension'])
                .range(['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#EF4444', '#EC4899']);

            // Create force simulation
            simulation = d3.forceSimulation(data.nodes)
                .force('link', d3.forceLink(data.links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));

            // Create links
            const link = svg.append('g')
                .selectAll('line')
                .data(data.links)
                .join('line')
                .attr('stroke', d => d.type === 'evolution' ? '#3B82F6' : '#10B981')
                .attr('stroke-width', 2)
                .attr('stroke-opacity', 0.6);

            // Create nodes
            const node = svg.append('g')
                .selectAll('circle')
                .data(data.nodes)
                .join('circle')
                .attr('r', 10)
                .attr('fill', d => colorScale(d.type))
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .style('cursor', 'pointer')
                .call(drag(simulation))
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip)
                .on('click', nodeClicked);

            // Add labels
            const label = svg.append('g')
                .selectAll('text')
                .data(data.nodes)
                .join('text')
                .text(d => d.entity.substring(0, 15))
                .attr('font-size', 10)
                .attr('dx', 12)
                .attr('dy', 4)
                .style('pointer-events', 'none');

            // Update positions on each tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
        }

        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            return d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended);
        }

        function showTooltip(event, d) {
            const tooltip = document.getElementById('nodeTooltip');
            const content = document.getElementById('tooltipContent');

            content.innerHTML = `
                <div class="font-semibold text-lg mb-2">${d.entity}</div>
                <div class="text-sm text-gray-600 mb-1">Type: <span class="font-medium">${d.type}</span></div>
                <div class="text-sm text-gray-600 mb-2">Author: <span class="font-medium">${d.author}</span></div>
                <div class="text-sm text-gray-700 mb-2">${d.why}</div>
                ${d.context ? `<div class="text-xs text-gray-500 italic">${d.context}</div>` : ''}
            `;

            tooltip.style.left = (event.pageX + 15) + 'px';
            tooltip.style.top = (event.pageY + 15) + 'px';
            tooltip.classList.remove('hidden');
        }

        function hideTooltip() {
            document.getElementById('nodeTooltip').classList.add('hidden');
        }

        function nodeClicked(event, d) {
            console.log('Node clicked:', d);
            // Could open a modal or navigate to entity details
        }

        function exportGraph() {
            const svg = document.getElementById('graphSvg');
            const svgData = new XMLSerializer().serializeToString(svg);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            canvas.width = svg.clientWidth;
            canvas.height = svg.clientHeight;

            img.onload = () => {
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'lattice-decision-graph.png';
                    a.click();
                    URL.revokeObjectURL(url);
                });
            };

            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
        }

        async function loadEntities() {
            try {
                const entities = await fetch('/api/entities').then(r => r.json());
                const container = document.getElementById('entitiesList');

                if (entities.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-center py-8">No entities found</div>';
                    return;
                }

                container.innerHTML = entities.map(entity => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-500 cursor-pointer">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${entity.entity}</h3>
                                <p class="text-sm text-gray-600">${entity.entity_type}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">${entity.decision_count} decisions</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading entities:', err);
            }
        }

        function renderDecisions(decisions, containerId) {
            const container = document.getElementById(containerId);

            if (decisions.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-8">No decisions found</div>';
                return;
            }

            container.innerHTML = decisions.map(d => `
                <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-500">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-semibold text-gray-900">${d.entity}</h3>
                        <span class="px-2 py-1 text-xs rounded ${getChangeTypeColor(d.change_type)}">${d.change_type}</span>
                    </div>
                    <p class="text-gray-700 mb-2">${d.why}</p>
                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                        <span>üìÅ ${d.entity_type}</span>
                        <span>üîß ${d.tool}</span>
                        <span>üìä ${(d.confidence * 100).toFixed(0)}%</span>
                        <span>üë§ ${d.author}</span>
                    </div>
                </div>
            `).join('');
        }

        function getChangeTypeColor(changeType) {
            const colors = {
                'created': 'bg-green-100 text-green-800',
                'updated': 'bg-blue-100 text-blue-800',
                'deprecated': 'bg-yellow-100 text-yellow-800',
                'deleted': 'bg-red-100 text-red-800',
            };
            return colors[changeType] || 'bg-gray-100 text-gray-800';
        }

        // Initialize
        loadDashboard();
    </script>
</body>
</html>
